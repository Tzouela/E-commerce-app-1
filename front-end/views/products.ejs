<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Products</title>
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css' />
</head>

<body class="bg-body-secondary">

  <%-include('./partials/navbar.ejs')%>

    <div class="container-fluid">
      <div class="mt-5">

        <div class="d-flex justify-content-between mb-3">
          <h2>Products</h2>
        </div>

        <div class="container py-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
          <form action="/products/search" method="POST" class="d-flex flex-wrap align-items-center">
            <div class="me-2" style="min-width: 150px;">
              <input type="text" class="form-control" id="productInput" name="name" placeholder="Product"
                value="<%= name %>" />
            </div>

            <div class="me-2" style="min-width: 150px;">
              <select class="form-select" id="categorySelect" name="category">
                <option value="" <%=!category ? "selected" : "" %>>Category</option>
                <% categories.forEach(function(c) { %>
                  <option value="<%= c.name %>" <%=category===c.name ? "selected" : "" %>>
                    <%= c.name %>
                  </option>
                  <% }); %>
              </select>
            </div>

            <div class="me-2" style="min-width: 150px;">
              <select class="form-select" id="brandSelect" name="brand">
                <option value="" <%=!brand ? "selected" : "" %>>Brand</option>
                <% brands.forEach(function(b) { %>
                  <option value="<%= b.name %>" <%=brand===b.name ? "selected" : "" %>>
                    <%= b.name %>
                  </option>
                  <% }); %>
              </select>
            </div>

            <button type="submit" class="btn btn-primary me-2">Search</button>
            <button type="button" class="btn btn-secondary me-2" onclick="window.location.href='/products'">Clear</button>
          </form>
          <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#productModal" data-mode="create">Create</button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table w-100">
            <thead class="table-dark">
              <tr>
                <th>Current Products</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <div class="table-responsive">
                    <table class="table table-striped table-bordered w-100">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Image</th>
                          <th>Image URL</th>
                          <th>Name</th>
                          <th>Description</th>
                          <th>Price</th>
                          <th>Quantity</th>
                          <th>Brand</th>
                          <th>Category</th>
                          <th>Deleted</th>
                          <th>Options</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% products.forEach(function(product) { %>
                          <tr>
                            <td>
                              <%= product.id %>
                            </td>
                            <td>
                              <img src="<%= product.image_url %>" alt="Product Image" width="75" height="75">
                            </td>
                            <td>
                              <%= product.image_url %>
                            </td>
                            <td>
                              <%= product.name %>
                            </td>
                            <td>
                              <%= product.description %>
                            </td>
                            <td>
                              $<%= product.price %>
                            </td>
                            <td>
                              <%= product.stock_quantity %>
                            </td>
                            <td>
                              <%= product.brand_name %>
                            </td>
                            <td>
                              <%= product.category_name %>
                            </td>
                            <td>
                              <% if (product.deleted_at) { %>
                                <form action="/products/<%= product.id %>/restore?_method=PUT" method="POST"
                                  class="m-0 p-0">
                                  <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="restoreSwitch-<%= product.id %>"
                                      checked onchange="this.form.submit()" aria-label="Restore product">
                                  </div>
                                </form>
                                <% } else { %>
                                  <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="restoreSwitch-<%= product.id %>"
                                      disabled>
                                  </div>
                                  <% } %>
                            </td>
                            <td>
                              <button type="button" class="btn btn-primary edit-btn" data-bs-toggle="modal"
                                data-bs-target="#productModal" data-mode="edit" data-id="<%= product.id %>"
                                data-image-url="<%=product.image_url %>" data-name="<%= product.name %>"
                                data-description="<%=product.description %>" data-price="<%= product.price %>"
                                data-quantity="<%=product.stock_quantity %>" data-brand-name="<%= product.brand_name %>"
                                data-category-name="<%= product.category_name %>">
                                Edit
                              </button>
                              <form
  action="/products/<%= product.id %>?_method=DELETE"
  method="POST"
  class="d-inline"
>
  <button type="submit" class="btn btn-danger">Delete</button>
</form>
                            </td>
                          </tr>
                          <% }); %>
                      </tbody>
                    </table>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="productModalLabel">
                Modal Title
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
              </button>
            </div>

            <div class="modal-body">
              <form id="productForm" action="/products" method="POST">
                <div id="methodOverrideContainer"></div>
                <input type="hidden" id="product-id" name="id" value="" />

                <div class="mb-3">
                  <label for="product-imgurl" class="form-label">
                    Image URL
                  </label>
                  <input type="text" class="form-control" id="product-imgurl" name="imgurl" required />
                </div>

                <div class="mb-3">
                  <label for="product-name" class="form-label">
                    Name
                  </label>
                  <input type="text" class="form-control" id="product-name" name="name" required />
                </div>

                <div class="mb-3">
                  <label for="product-description" class="form-label">
                    Description
                  </label>
                  <textarea class="form-control" id="product-description" name="description" rows="3"
                    required></textarea>
                </div>

                <div class="mb-3">
                  <label for="product-price" class="form-label">
                    Price
                  </label>
                  <input type="number" step="0.01" class="form-control" id="product-price" name="price" required />
                </div>

                <div class="mb-3">
                  <label for="product-quantity" class="form-label">
                    Quantity
                  </label>
                  <input type="number" class="form-control" id="product-quantity" name="quantity" required />
                </div>

                <div class="mb-3">
                  <label for="product-brand" class="form-label">
                    Brand
                  </label>
                  <select class="form-select" id="product-brand" name="brandName" required>
                    <option value="" disabled>Select a brand…</option>
                    <% brands.forEach(function(b) { %>
                      <option value="<%= b.name %>">
                        <%= b.name %>
                      </option>
                      <% }); %>
                  </select>
                </div>

                <div class="mb-3">
                  <label for="product-category" class="form-label">
                    Category
                  </label>
                  <select class="form-select" id="product-category" name="categoryName" required>
                    <option value="" disabled>Select a category…</option>
                    <% categories.forEach(function(c) { %>
                      <option value="<%= c.name %>">
                        <%= c.name %>
                      </option>
                      <% }); %>
                  </select>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Close
                  </button>
                  <button type="submit" class="btn btn-primary" id="modalSaveBtn">
                    Save
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js">
      </script>
      <script src="/javascript/productModal.js"></script>
</body>

</html>